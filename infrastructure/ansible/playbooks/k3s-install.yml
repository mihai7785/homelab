---
- name: Install k3s server
  hosts: k3s_server
  become: true
  vars:
    k3s_version: "v1.32.2+k3s1"

  tasks:
    - name: Download k3s install script
      get_url:
        url: https://get.k3s.io
        dest: /tmp/k3s-install.sh
        mode: '0755'

    - name: Install k3s server
      shell: |
        INSTALL_K3S_VERSION={{ k3s_version }} \
        INSTALL_K3S_EXEC="server \
          --disable traefik \
          --disable servicelb \
          --cluster-cidr=10.42.0.0/16 \
          --service-cidr=10.43.0.0/16 \
          --flannel-backend=vxlan" \
        /tmp/k3s-install.sh
      args:
        creates: /usr/local/bin/k3s

    - name: Wait for k3s to be ready
      wait_for:
        path: /var/lib/rancher/k3s/server/node-token
        timeout: 60

    - name: Get k3s node token
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: k3s_token

    - name: Get kubeconfig
      slurp:
        src: /etc/rancher/k3s/k3s.yaml
      register: kubeconfig

- name: Install k3s workers
  hosts: k3s_workers
  become: true
  vars:
    k3s_version: "v1.32.2+k3s1"
    k3s_token: "{{ hostvars['k3s-server-01']['k3s_token']['content'] | b64decode | trim }}"

  tasks:
    - name: Download k3s install script
      get_url:
        url: https://get.k3s.io
        dest: /tmp/k3s-install.sh
        mode: '0755'

    - name: Write token to file
      copy:
        content: "{{ k3s_token }}"
        dest: /tmp/k3s-token
        mode: '0600'

    - name: Install k3s worker
      shell: |
        INSTALL_K3S_VERSION={{ k3s_version }} \
        K3S_URL=https://192.168.1.201:6443 \
        K3S_TOKEN=$(cat /tmp/k3s-token) \
        /tmp/k3s-install.sh
      args:
        creates: /usr/local/bin/k3s

    - name: Wait for k3s agent to start
      systemd:
        name: k3s-agent
        state: started
        enabled: true

    - name: Remove token file
      file:
        path: /tmp/k3s-token
        state: absent